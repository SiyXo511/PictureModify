# 图片修改工具 - 项目需求文档

## 项目概述
开发一个桌面应用程序，用于图片编辑，主要功能包括垂直区域删除拼接和选中区域智能填充。

## 核心功能需求

### 1. 图片加载与显示
- 支持常见图片格式（JPG, PNG, BMP, GIF等）
- 图片预览和缩放显示
- 支持拖拽加载图片

### 2. 选择工具
- 矩形选择工具
- 支持鼠标拖拽选择区域
- 实时显示选择框
- 显示选择区域的坐标和尺寸信息

### 3. 功能一：垂直删除并拼接
- 用户垂直选中图片的一部分（矩形区域）
- 删除选中区域
- 将删除区域上方的部分和下方的部分垂直拼接
- 保持图片宽度不变，高度相应减少

### 4. 功能二：选中区域删除并背景填充
- 用户选中图片的任意区域（矩形区域）
- 删除选中区域的内容
- 使用智能算法填充背景：
  - 选项A：使用周围像素的平均值/中位数进行填充
  - 选项B：使用图像修复算法（如OpenCV的inpaint）
  - 选项C：使用纯色填充（用户可选择颜色）
  - 选项D：使用渐变填充（基于周围像素）

### 5. 功能三：文字识别、删除与替换
- **文字识别（OCR）**：
  - 用户选中包含文字的区域
  - 使用OCR技术识别选中区域中的文字内容
  - 显示识别结果供用户确认或修改
  - 支持中文、英文等多种语言识别
  
- **文字删除**：
  - 识别文字位置和范围
  - 使用智能填充算法删除文字（保留背景）
  - 支持批量删除多个文字区域
  
- **文字替换**：
  - 识别原文字的字体特征（字体类型、大小、颜色、样式等）
  - 用户输入要替换的新文字
  - 使用相同或相似的字体特征渲染新文字
  - 将新文字放置在原文字位置
  - 支持字体参数手动调整（大小、颜色、粗细等）

- **字体识别与匹配**：
  - 分析原文字的字体特征：
    - 字体类型（如宋体、黑体、Arial等）
    - 字体大小
    - 字体颜色（RGB值）
    - 字体样式（粗体、斜体等）
    - 字符间距
  - 尝试匹配系统可用字体
  - 如果无法完全匹配，使用最相似的字体
  - 允许用户手动选择字体

### 6. 辅助功能
- 撤销/重做操作（建议支持至少10步）
- 保存编辑后的图片
- 另存为功能
- 重置到原始图片
- 图片缩放查看（放大/缩小/适应窗口）

## 技术栈建议

### 开发语言
- Python 3.8+

### 核心库
- **GUI框架**：PyQt5 或 tkinter
  - PyQt5：功能强大，界面美观，推荐
  - tkinter：Python内置，无需额外安装
  
- **图像处理**：
  - Pillow (PIL)：基础图像操作和文字渲染
  - OpenCV (cv2)：高级图像处理，用于智能填充
  - NumPy：数组操作支持
  
- **文字识别（OCR）**：
  - PaddleOCR：推荐，支持中英文，识别准确率高
  - EasyOCR：备选方案，支持多语言
  - Tesseract：备选方案，需要额外安装
  
- **字体处理**：
  - fonttools：字体文件分析和操作
  - 系统字体库：获取可用字体列表

- **打包工具**：
  - PyInstaller：将Python程序打包成exe

### 项目结构
```
PictureModify/
├── src/
│   ├── main.py              # 程序入口
│   ├── gui/
│   │   ├── __init__.py
│   │   ├── main_window.py   # 主窗口
│   │   └── image_canvas.py  # 图片显示画布
│   ├── core/
│   │   ├── __init__.py
│   │   ├── image_processor.py  # 图像处理核心逻辑
│   │   ├── selection_tool.py   # 选择工具
│   │   ├── ocr_processor.py    # OCR文字识别处理
│   │   └── text_editor.py      # 文字编辑和替换
│   └── utils/
│       ├── __init__.py
│       └── file_handler.py     # 文件操作
├── requirements.txt
├── README.md
└── build_exe.py              # 打包脚本
```

## 用户界面设计

### 主窗口布局
- **顶部菜单栏**：
  - 文件：打开、保存、另存为、退出
  - 编辑：撤销、重做、重置
  - 工具：垂直删除拼接、智能填充、文字识别替换
  - 视图：缩放、适应窗口
  
- **工具栏**：
  - 打开图片按钮
  - 选择工具按钮
  - 垂直删除拼接按钮
  - 智能填充按钮
  - 文字识别按钮
  - 文字替换按钮
  - 撤销/重做按钮
  - 保存按钮

- **主显示区**：
  - 图片显示画布
  - 支持鼠标选择区域
  - 显示选择框

- **状态栏**：
  - 显示图片信息（尺寸、格式）
  - 显示选择区域信息
  - 显示操作提示

## 技术实现细节

### 垂直删除拼接算法
1. 获取选择区域的y坐标范围（y1, y2）
2. 将原图分为三部分：
   - 上部：y < y1
   - 选中部分：y1 <= y < y2（删除）
   - 下部：y >= y2
3. 将上部和下部垂直拼接
4. 返回新图片

### 智能填充算法
1. **简单填充**：使用周围像素的平均值
2. **高级填充**：使用OpenCV的inpaint算法
   - cv2.INPAINT_TELEA 或 cv2.INPAINT_NS
3. **颜色填充**：用户选择颜色，直接填充
4. **渐变填充**：基于边界像素生成渐变

### 文字识别与替换算法
1. **OCR识别**：
   - 使用PaddleOCR或EasyOCR识别选中区域的文字
   - 返回文字内容和位置信息（边界框）
   - 支持中英文混合识别
   
2. **字体特征提取**：
   - 分析文字区域的视觉特征：
     - 字体大小（基于文字高度）
     - 字体颜色（提取文字像素的平均颜色）
     - 字体粗细（通过边缘检测判断）
     - 字符间距（通过字符边界框计算）
   - 尝试识别字体类型（可能需要字体识别库或机器学习模型）
   
3. **字体匹配**：
   - 获取系统可用字体列表
   - 根据提取的特征匹配最相似的字体
   - 如果无法匹配，使用默认字体（如SimHei、Arial）
   - 允许用户手动选择字体
   
4. **文字删除**：
   - 对每个识别到的文字区域使用智能填充算法
   - 使用OpenCV的inpaint算法填充文字区域
   - 保持背景自然
   
5. **文字渲染**：
   - 使用PIL的ImageDraw和ImageFont渲染新文字
   - 应用匹配的字体、大小、颜色
   - 计算文字位置（居中或左对齐）
   - 支持文字描边和阴影效果（如果需要）

### 撤销/重做机制
- 使用列表存储历史状态
- 每次操作前保存当前图片状态
- 限制历史记录数量（如10-20步）

## 打包配置

### PyInstaller配置
- 单文件打包（--onefile）
- 包含图标文件
- 隐藏控制台窗口（--windowed）
- 优化打包体积

## 用户体验优化
- 操作提示和帮助信息
- 快捷键支持（Ctrl+Z撤销，Ctrl+S保存等）
- 进度提示（处理大图片时）
- 错误处理和提示
- 支持中文界面

## 扩展功能（可选）
- 支持批量处理
- 更多选择工具（圆形、多边形）
- 图片滤镜效果
- 历史记录预览
- 导出处理步骤记录
- 文字样式高级调整（描边、阴影、渐变等）
- 支持多行文字识别和替换
- 文字识别结果导出为文本文件

