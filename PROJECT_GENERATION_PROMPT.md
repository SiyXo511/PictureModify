# 图片修改工具 - 完整项目生成Prompt

请帮我开发一个完整的图片修改桌面应用程序，具体要求如下：

## 项目概述
开发一个基于Python的桌面图片编辑工具，主要功能包括：
1. 删除图片中的选中区域（垂直删除拼接和智能背景填充）
2. 文字识别、删除与替换（OCR识别图片中的文字，删除原文字并用相同字体替换为新文字）

## 技术栈要求
- **编程语言**：Python 3.8+
- **GUI框架**：PyQt5（优先）或tkinter
- **图像处理库**：
  - Pillow (PIL) - 基础图像操作和文字渲染
  - OpenCV (cv2) - 高级图像处理和智能填充
  - NumPy - 数组操作
  
- **文字识别（OCR）库**：
  - PaddleOCR - 推荐，支持中英文，识别准确率高，易于使用
  - EasyOCR - 备选方案，支持多语言
  - 注意：PaddleOCR需要下载模型文件，首次使用会自动下载
  
- **字体处理**：
  - fonttools - 字体文件分析（可选）
  - 系统字体库 - 获取可用字体列表
  
- **打包工具**：PyInstaller（用于生成exe文件）

## 核心功能实现

### 1. 主窗口界面
- 使用PyQt5创建现代化GUI界面
- 包含菜单栏、工具栏、图片显示区域、状态栏
- 支持中文界面
- 响应式布局，支持窗口缩放

### 2. 图片加载与显示
- 支持打开常见图片格式（JPG, PNG, BMP, GIF, WEBP等）
- 图片在画布上显示，支持缩放以适应窗口
- 支持鼠标滚轮缩放
- 显示图片基本信息（尺寸、格式、文件路径）

### 3. 矩形选择工具
- 实现鼠标拖拽选择矩形区域
- 实时显示选择框（虚线边框）
- 显示选择区域的坐标和尺寸
- 支持重新选择（点击空白区域取消选择）
- 选择框颜色醒目（如红色或蓝色）

### 4. 功能一：垂直删除并拼接
- 当用户点击"垂直删除拼接"按钮时：
  1. 检查是否有选中区域，如果没有则提示用户
  2. 获取选中区域的垂直范围（y坐标）
  3. 将原图分为三部分：
     - 上部：y坐标 < 选中区域上边界
     - 选中部分：选中区域（将被删除）
     - 下部：y坐标 >= 选中区域下边界
  4. 删除选中部分
  5. 将上部和下部垂直拼接，保持原图宽度
  6. 更新显示，显示处理后的图片
  7. 保存操作到历史记录（用于撤销）

### 5. 功能二：选中区域删除并背景填充
- 提供多种填充模式供用户选择：
  
  **模式A - 智能填充（推荐）**：
  - 使用OpenCV的inpaint算法
  - 使用cv2.INPAINT_TELEA或cv2.INPAINT_NS方法
  - 基于周围像素智能填充，效果自然
  
  **模式B - 平均颜色填充**：
  - 计算选中区域周围像素的平均颜色
  - 使用该颜色填充选中区域
  
  **模式C - 纯色填充**：
  - 弹出颜色选择对话框
  - 用户选择颜色后填充
  
  **模式D - 中位数填充**：
  - 使用周围像素的中位数颜色填充
  - 效果比平均值更稳定

- 实现步骤：
  1. 检查是否有选中区域
  2. 弹出填充模式选择对话框
  3. 根据选择的模式执行相应算法
  4. 更新显示
  5. 保存到历史记录

### 6. 撤销/重做功能
- 实现操作历史记录系统
- 支持至少10步撤销/重做
- 使用列表存储图片状态（PIL Image对象）
- 菜单栏和工具栏提供撤销/重做按钮
- 快捷键：Ctrl+Z（撤销），Ctrl+Y或Ctrl+Shift+Z（重做）
- 当无法撤销/重做时，按钮应禁用

### 7. 文件操作
- **打开文件**：
  - 文件对话框选择图片
  - 支持拖拽文件到窗口打开
  - 快捷键：Ctrl+O
  
- **保存文件**：
  - 保存当前编辑的图片
  - 快捷键：Ctrl+S
  
- **另存为**：
  - 选择保存路径和格式
  - 快捷键：Ctrl+Shift+S
  
- **重置**：
  - 恢复到原始图片
  - 清空历史记录

### 8. 功能三：文字识别、删除与替换

#### 8.1 文字识别（OCR）
- 当用户点击"文字识别"按钮时：
  1. 检查是否有选中区域，如果没有则提示用户
  2. 提取选中区域的图片
  3. 使用PaddleOCR进行文字识别：
     - 初始化PaddleOCR（支持中英文）
     - 对选中区域进行OCR识别
     - 返回识别结果：文字内容、位置坐标（边界框）、置信度
  4. 显示识别结果对话框：
     - 列出所有识别到的文字
     - 显示每个文字的位置和置信度
     - 允许用户编辑识别结果（修正错误）
     - 支持选择要处理的文字（可多选）
  5. 将识别结果保存到内存，供后续使用

#### 8.2 文字删除
- 当用户选择"删除文字"时：
  1. 获取选中的文字区域列表
  2. 对每个文字区域：
     - 创建掩码（mask），标记文字区域
     - 使用OpenCV的inpaint算法智能填充
     - 保持背景自然，去除文字痕迹
  3. 更新显示
  4. 保存到历史记录

#### 8.3 文字替换
- 当用户选择"替换文字"时：
  1. 显示文字替换对话框：
     - 显示原文字内容
     - 输入框供用户输入新文字
     - 显示检测到的字体参数（大小、颜色等）
     - 允许用户调整字体参数：
       - 字体类型选择（下拉列表，显示系统可用字体）
       - 字体大小（滑块或输入框）
       - 字体颜色（颜色选择器）
       - 字体样式（粗体、斜体复选框）
   
  2. **字体特征提取**：
     - 分析原文字区域的视觉特征：
       - **字体大小**：基于文字边界框的高度计算
       - **字体颜色**：
         - 提取文字像素（非背景像素）的平均RGB值
         - 可以使用K-means聚类找到主要文字颜色
       - **字体粗细**：
         - 通过边缘检测（Canny）判断线条粗细
         - 或通过文字区域的像素密度判断
       - **字符间距**：通过相邻字符边界框的距离计算
       - **字体类型识别**（可选，较复杂）：
         - 可以尝试使用字体识别模型
         - 或通过特征匹配（如笔画特征）判断
         - 如果无法识别，使用默认字体匹配
   
  3. **字体匹配**：
     - 获取系统可用字体列表（使用PIL的ImageFont）
     - 根据提取的特征匹配最相似的字体：
       - 优先匹配中文字体（如果识别到中文）
       - 优先匹配英文字体（如果识别到英文）
       - 常用字体映射：
         - 粗体 → SimHei（黑体）、Arial Bold
         - 细体 → SimSun（宋体）、Arial
         - 等宽 → SimHei、Courier New
     - 如果无法匹配，使用默认字体：
       - 中文：SimHei（黑体）或 Microsoft YaHei（微软雅黑）
       - 英文：Arial
     - 允许用户手动选择字体
   
  4. **文字渲染**：
     - 使用PIL的ImageDraw和ImageFont：
       ```python
       from PIL import ImageDraw, ImageFont
       draw = ImageDraw.Draw(image)
       font = ImageFont.truetype(font_path, font_size)
       draw.text((x, y), new_text, fill=font_color, font=font)
       ```
     - 计算文字位置：
       - 获取原文字的中心点或左上角坐标
       - 计算新文字的大小（使用textbbox）
       - 调整位置使新文字居中在原文字位置
     - 应用字体参数：
       - 使用匹配的字体文件
       - 应用字体大小
       - 应用字体颜色
       - 应用字体样式（粗体、斜体）
   
  5. **文字删除后替换**（可选优化）：
     - 先删除原文字（使用inpaint）
     - 再在新位置渲染新文字
     - 这样效果更自然
   
  6. 更新显示
  7. 保存到历史记录

#### 8.4 文字编辑界面设计
- **文字识别结果对话框**：
  - 表格显示识别结果（文字内容、位置、置信度）
  - 复选框选择要处理的文字
  - "删除选中文字"按钮
  - "替换选中文字"按钮
  - "取消"按钮

- **文字替换对话框**：
  - 显示原文字内容（只读）
  - 新文字输入框
  - 字体选择下拉框（显示系统字体列表）
  - 字体大小滑块（10-200）
  - 颜色选择器
  - 样式复选框（粗体、斜体）
  - "预览"按钮（在图片上临时显示效果）
  - "确定"和"取消"按钮

### 9. 视图功能
- 适应窗口：自动缩放图片以适应窗口大小
- 实际大小：显示图片原始尺寸（100%缩放）
- 放大/缩小：支持鼠标滚轮或按钮缩放
- 显示缩放比例

## 项目结构要求

```
PictureModify/
├── src/
│   ├── main.py                    # 程序入口点
│   ├── gui/
│   │   ├── __init__.py
│   │   ├── main_window.py         # 主窗口类，继承QMainWindow
│   │   └── image_canvas.py        # 图片显示画布，继承QWidget或QLabel
│   ├── core/
│   │   ├── __init__.py
│   │   ├── image_processor.py     # 图像处理核心类
│   │   ├── selection_manager.py   # 选择区域管理类
│   │   ├── ocr_processor.py       # OCR文字识别处理类
│   │   └── text_editor.py         # 文字编辑和替换类
│   └── utils/
│       ├── __init__.py
│       ├── file_handler.py        # 文件操作工具
│       └── history_manager.py     # 历史记录管理类
├── requirements.txt               # 依赖包列表
├── README.md                      # 项目说明文档
├── build_exe.py                   # PyInstaller打包脚本
└── icon.ico                       # 应用图标（可选）
```

## 代码质量要求

1. **代码规范**：
   - 遵循PEP 8 Python代码规范
   - 使用有意义的变量和函数名
   - 添加必要的注释（中文或英文）
   - 函数和类添加docstring

2. **错误处理**：
   - 完善的异常处理机制
   - 用户友好的错误提示
   - 处理文件不存在、格式不支持等情况

3. **性能优化**：
   - 大图片处理时显示进度条
   - 使用多线程避免界面卡顿
   - 合理的内存管理

4. **用户体验**：
   - 操作有明确的视觉反馈
   - 状态栏显示操作提示
   - 快捷键支持
   - 界面美观现代

## 具体实现细节

### main_window.py 应包含：
- QMainWindow主窗口类
- 菜单栏创建（文件、编辑、工具、视图、帮助）
- 工具栏创建（常用功能按钮）
- 状态栏创建（显示信息）
- 信号槽连接
- 事件处理（键盘快捷键等）

### image_canvas.py 应包含：
- 图片显示组件
- 鼠标事件处理（选择、拖拽）
- 绘制选择框
- 图片缩放和滚动

### image_processor.py 应包含：
- `vertical_delete_and_stitch(image, selection_rect)` 方法
- `smart_fill(image, selection_rect, fill_mode)` 方法
  - fill_mode: 'inpaint', 'average', 'color', 'median'
- 各种填充算法的实现

### ocr_processor.py 应包含：
- `__init__()` 方法：初始化PaddleOCR
- `recognize_text(image_region)` 方法：
  - 输入：图片区域（PIL Image或numpy array）
  - 返回：识别结果列表，每个结果包含：
    - text: 文字内容
    - bbox: 边界框坐标 [[x1,y1], [x2,y2], [x3,y3], [x4,y4]]
    - confidence: 置信度
- `get_system_fonts()` 方法：获取系统可用字体列表

### text_editor.py 应包含：
- `extract_font_features(image, text_bbox)` 方法：
  - 提取字体特征（大小、颜色、粗细等）
  - 返回字体特征字典
- `match_font(font_features, text_content)` 方法：
  - 根据特征匹配最相似的字体
  - 返回字体路径和参数
- `delete_text(image, text_bboxes)` 方法：
  - 删除多个文字区域
  - 使用inpaint算法
- `replace_text(image, old_text_bbox, new_text, font_params)` 方法：
  - 替换文字
  - 参数：原文字位置、新文字内容、字体参数
  - 返回处理后的图片

### selection_manager.py 应包含：
- 选择区域的数据结构
- 选择区域的验证
- 坐标转换（画布坐标 ↔ 图片坐标）

### history_manager.py 应包含：
- 历史记录列表管理
- 保存当前状态
- 撤销/重做操作
- 限制历史记录数量

## 打包配置

### requirements.txt 应包含：
```
PyQt5>=5.15.0
Pillow>=9.0.0
opencv-python>=4.5.0
numpy>=1.21.0
paddlepaddle>=2.4.0
paddleocr>=2.6.0
PyInstaller>=5.0.0
```

注意：PaddleOCR首次使用时会自动下载模型文件，可能需要一些时间。
如果PaddleOCR安装有问题，可以使用EasyOCR作为备选：
```
easyocr>=1.6.0
```

### build_exe.py 应包含：
- PyInstaller配置
- 单文件打包（--onefile）
- 隐藏控制台（--windowed）
- 包含必要的资源文件
- 生成exe文件的命令

## 测试要求
- 测试各种图片格式的加载
- 测试垂直删除拼接功能
- 测试各种填充模式
- 测试撤销/重做功能
- 测试边界情况（选择整个图片、选择边缘区域等）
- 测试OCR文字识别（中文、英文、中英文混合）
- 测试文字删除功能
- 测试文字替换功能（字体匹配、颜色匹配等）
- 测试不同字体大小的文字识别和替换

## 额外要求
1. 代码应该是完整可运行的
2. 所有功能都应该有对应的UI按钮或菜单项
3. 提供清晰的README说明如何使用
4. 代码应该有良好的错误处理
5. 界面应该支持中文显示
6. OCR识别可能需要一些时间，需要显示进度提示
7. 字体匹配如果失败，应该有友好的提示和备选方案
8. 文字替换时，如果新文字长度与原文字差异很大，需要智能调整位置
9. 支持多行文字的识别和替换
10. OCR模型文件较大，首次使用需要下载，需要提示用户

## 交付物
请生成完整的项目代码，包括：
1. 所有源代码文件
2. requirements.txt
3. README.md（包含使用说明）
4. build_exe.py（打包脚本）
5. 确保代码可以直接运行

请开始生成完整的项目代码。

